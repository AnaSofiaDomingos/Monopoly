<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="./socket.io-1.3.4.js"></script>
	<link rel="stylesheet" type="text/css" href="./css/pion.css">
	<!--<script src="cards.js" type="text/javascript"></script>-->
	<title>Monopoly</title>
	<script>

		// States
		var S_DEAD   = -1;
		var S_ALIVE  = 0;
		var S_JAILED = 1;
		var S_PUBLIC = 2;
		var S_NO_INT = 3;
		var S_NO_WAT = 4;
		var S_NO_ELE = 5;
	
		// Constants
		var SALARY    = 0.1;
		var TAXES     = 0.05;
		var CARDS     = 20; // King Burgonde not implemented (id 21)
	
		// Variables
		var jail_time = 0;
	
		var GameID = 1;
		var idGlobal = Math.floor(Math.random() * 4) + 1;
		var idPlayer;
		var sentJson;

		var owns = [
			{
				'country' : 24,
				'level' : 2
			},	
			{
				'country' : 22,
				'level' : 1
			}
		];
		
		var localJson = [{
				"owns" : owns,
				"cards" : [{}],
				"loans" : [{}]
		}, {
				"owns" : [{}],
				"cards" : [{}],
				"loans" : [{}]
		}, {
				"owns" : [{}],
				"cards" : [{}],
				"loans" : [{}]
		}, {
				"owns" : [{}],
				"cards" : [{}],
				"loans" : [{}]
		}, {
				"owns" : [{}],
				"cards" : [{}],
				"loans" : [{}]
		}, {
				"owns" : [{}],
				"cards" : [{}],
				"loans" : [{}]
		}];

		// console.log(idGlobal);
		var data = {
			'RoomID'  : GameID,
			'idGlobal' : idGlobal
		};

		var nbCase = 36;
		var countries, cards;


		// fonction permettant de construire les cases de chaque pays et carte
		function constructionCase(typecase, id, sens, parent ){
			if (sens == 1)
				for (var i = id; i < (id+8); i++)
					$('#'+parent).append("<div id='case" + i + "' class='"+ typecase + "' onclick='getInfos("+i+")' ></div>");
			else
				for (var i = id; i > (id-8); i--)
					$('#'+parent).append("<div id='case" + i + "' class='"+ typecase + "' onclick='getInfos("+i+")'></div>");
		}


		// affiche les informations de la case apres avoir cliquer dessus
		function getInfos(position, pays){
			// empeche le click des cases spéciales
			if (position == 0 | position == 3 | position == 6 | position == 9 | position == 12 | position == 15 |
				position == 18 | position == 21 | position == 24 | position == 27 | position == 30 | position == 33)
				return ;

			var level, owned =false;
			var idpays, country;
			$('#infosPays').empty();
			$('#infosPays').append("Information case</br>");


			// si un id pays est donnée en paramètre pas besoin d'aller chercher dans la liste des pays
			if (pays == undefined){
				country = findCountry(position);
				$('#infosPays').append("<label>" + country.NomPays + "</label></br>");
				idpays = country.idPays;

			}else{
				var nom = getById(pays, 'pays');
				$('#infosPays').append("<label>" + nom + "</label></br>");
				idpays = pays;
			}


			// affiche le level du pays
			for (var i=0; i<localJson[idPlayer].owns.length;i++){
				if (localJson[idPlayer].owns[i].country == idpays){
					level = true;
					$('#infosPays').append("<label>Level " + localJson[idPlayer].owns[i].level + "</label></br>");
				}
			}

			if (level==false)
					$('#infosPays').append("<label>Level 0</label></br>");


			// affiche le propriétaire du pays
			for (var i=0;i<localJson.length;i++){
				for (var j=0; j<localJson[i].owns.length;j++){
					if (localJson[i].owns[j].country == idpays){
						owned = true;
						$('#infosPays').append("<label>Propriétaire " + i + "</label></br>");
						$('#infosPays').append('<input class="btnSell" type="button" value="vendre" onclick="sell('+idpays+')" />');
						$('#infosPays').append('<input class="btnLoan" type="button" value="hypothéquer" onclick="loan('+idpays+')" />');
					}
				}
			}

			if (owned==false){
				$('#infosPays').append("<label>Aucun propriétaire</label></br>");

				// affiche le prix du pays si personne ne l'a acheter
				$('#infosPays').append("<label>Prix " + country.Prix + " millons </label></br>");
			}

			// affiche les boutons en fonction de la position locale
			if (posLocal == position){
				if (owned == true){
					$('#infosPays').append('<input id="btnUpgrade" type="button" value="améliorer" onclick="upgrade(idPlayer)" />');
				}
				else
					$('#infosPays').append('<input id="btnBuy" type="button" value="Acheter" onclick="buy()" />');
			}
			
		}

		// place le pays dans les div
		function placeCountriesCartes(){
			for (var i=0; i<nbCase;i++){
				var country = findCountry(i);
				if (country != undefined)
					$('#case'+ i).append("<span class='case'>"+ country.NomPays +"</span>");
			}

			// taxes
			$('#case3').append("<span class='case'>Taxes</span>");
			$('#case12').append("<span class='case'>Taxes</span>");
			$('#case21').append("<span class='case'>Taxes</span>");
			$('#case30').append("<span class='case'>Taxes</span>");

			// cartes 
			$('#case6').append("<span class='case'>Carte</span>");
			$('#case15').append("<span class='case'>Carte</span>");
			$('#case24').append("<span class='case'>Carte</span>");
			$('#case33').append("<span class='case'>Carte</span>");

			// coins
			$('#case0').append("<span class='case'>Depart</span>");
			$('#case9').append("<span class='case'>Prison</span>");
			$('#case18').append("<span class='case'>Parking</span>");
			$('#case27').append("<span class='case'>Aller Prison</span>");
		}

		// trouve le pays correspondant à la case avec la position
		function findCountry(id){
			for (var i=0; i< countries.length;i++){
				if (countries[i].Position == id)
					return countries[i];

			}
		}

		/*  retrouve le nom du pays en fonction de l'id si table = pays
			retrouve le contenu de la carte en fonction de l'ip si table = cartes*/
		function getById(id, table){
			if (table == 'pays'){
				for (var i=0; i< countries.length; i++){
					if (countries[i].idPays == id)
						return countries[i].NomPays;
				}
			}
			/*else if (table == 'carte') {
				for (var i=0; i< carte.length; i++){
					
				}
			}*/

		}
		

		// recupere les information en fonction d'un id
		function getMyInfos(){
			$("#pays").empty();
			$("#cartes").empty();
			$("#credit").empty();


			// liste les owns
			for (var i=0; i < localJson[idPlayer].owns.length; i++){
				var nom = getById(localJson[idPlayer].owns[i].country, 'pays');
				$('#pays').append("<div class='possede' onclick='getInfos(-1,"+ localJson[idPlayer].owns[i].country+")' >" + nom + "</div>");
			}
			$('#pays').append("</br>");

			// liste les loans
			for (var i=0; i < localJson[idPlayer].loans.length; i++){
				if (localJson[idPlayer].loans[i].country  != undefined){
					var nom = getById(localJson[idPlayer].loans[i].country, 'pays');
					$('#pays').append("<div class='hypotheque'>" + nom + "</div>");
				}
			}
			
			// liste le cartes
			for (var i=0; i < localJson[idPlayer].cards.length; i++)
				if (localJson[idPlayer].cards[i].card  != undefined)
					$('#cartes').append("<div class='possede'>" + localJson[idPlayer].cards[i].card + "</div>");

			$('#credit').append("<p>"+ sentJson.account +"</p>"); 

		}

		var socket = io('http://129.194.185.13/:8080/subscribe');

		socket.emit('handshake', data); // tell the server which game this user is part of

		socket.on('notify',function(data){
			receiveData(data);
		});

		socket.on('PlayerNumber',function(idLocal,dataInitGame){
			idPlayer = idLocal;
			dataInitGame.upgraded = [{
				"country": 25, // Suisse
				"level": "2"
			}];

			countries = dataInitGame.pays;
			card = dataInitGame.cartes;
 			

			sentJson = {
				"id": idPlayer,

				"bought": dataInitGame.bought,

				"upgraded": dataInitGame.upgraded,

				"sold" : dataInitGame.sold,
				"used" : dataInitGame.used,

				"loaned": dataInitGame.loaned,

				"drew": dataInitGame.drew,
				"recovered" : dataInitGame.recovered,
				"account": dataInitGame.account,
				"state" : dataInitGame.state,
				"position": joueurs[idPlayer],
				"GameID" : GameID

			};

			updateUpgrades(sentJson.upgraded);
			init(idPlayer);
			placeCountriesCartes();
			getMyInfos(idPlayer);
		});

	</script>
	<script src="move.js" type="text/javascript"></script>
	<script src="communication.js" type="text/javascript"></script>
	<script src="bank.js" type="text/javascript"></script>
</head>
<body>
	<div id="plateau">
		<div id="amérique">
			<div id="case18" class="case-coin" onclick='getInfos(18)'></div>
			<script> constructionCase("case-horizontal",19, 1,'amérique'); </script>
			<div id="case27" class="case-coin" onclick='getInfos(27)'></div>
		</div>

		<div id="asie">
			<script> constructionCase("case-vertical", 17, 0,'asie'); </script>
		</div>

		<div id="case-centrale"></div>

		<div id="europe">
			<script> constructionCase("case-vertical", 28, 1,'europe'); </script>
		</div>

		<div id="afrique">
			<div id="case9" class="case-coin" onclick='getInfos(9)'></div>
			<script> constructionCase("case-horizontal", 8, 0 ,'afrique'); </script>
			<div id="case0" class="case-coin" onclick='getInfos(0)'></div>
		</div>

	</div>
	</br>
	<div id='infosPays'>
		information case
		</br>
	</div>
	</br>

	<div id="infoAccount">
		<label>PAYS</label>
		<div id="pays"></div>
		<br/>
		<label >CARTES</label>
		<div id="cartes"></div>

		<br/>
		<label>CREDIT</label>
		<div id="credit"></div>

		<br/>
	</div>
	</br>

	<div id="actions">
		<input id="btnDes" type="button" value="Lancer les dés" onclick="lancerDes(idPlayer)" />
		<input id="btnFinTour" type="button" value="Fin du tour" onclick="finTour(GameID,idPlayer)" />
	
		<br/>
	</div>

</body>
</html>
